# 🚀 WonyBot RAG System Architecture

## 🎯 핵심 목표
- **고성능 검색**: 벡터 + 키워드 하이브리드 검색
- **다양한 문서 지원**: PDF, DOCX, MD, TXT, 웹페이지
- **실시간 학습**: 대화 중 즉시 문서 추가
- **스마트 컨텍스트**: 관련성 높은 정보만 선별
- **확장 가능**: 플러그인 시스템으로 소스 추가

## 🏗️ RAG 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                        입력 소스                              │
│  📄 PDF   📝 DOCX   📑 Markdown   🌐 Web   💬 Chat History  │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                   Document Processor                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Loaders    │  │   Chunkers   │  │  Extractors  │     │
│  │ (Langchain)  │  │  (Semantic)  │  │  (Metadata)  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                    Embedding Pipeline                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Sentence    │  │   Ollama     │  │    Cache     │     │
│  │ Transformers │  │  Embeddings  │  │   Manager    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                    Vector Database                           │
│  ┌──────────────────────────────────────────────────┐      │
│  │                   ChromaDB                        │      │
│  │  • Collections: documents, chat, web              │      │
│  │  • Metadata: source, date, type, tags            │      │
│  │  • Indexes: HNSW for similarity search           │      │
│  └──────────────────────────────────────────────────┘      │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                    Retrieval System                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Vector     │  │   Keyword    │  │   Reranker   │     │
│  │   Search     │  │    (BM25)    │  │  (CrossEnc)  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                    RAG Chain                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Context    │  │   Prompt     │  │   Response   │     │
│  │   Builder    │  │  Optimizer   │  │  Generator   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

## 💾 벡터 데이터베이스 선택: ChromaDB

### 장점
- **로컬 실행**: 서버 불필요
- **빠른 설정**: pip install로 즉시 사용
- **영속성**: 디스크 저장 지원
- **메타데이터**: 풍부한 필터링 옵션

### 데이터 구조
```python
{
    "id": "doc_uuid",
    "embeddings": [0.1, 0.2, ...],  # 768차원
    "documents": "원본 텍스트",
    "metadatas": {
        "source": "file.pdf",
        "page": 1,
        "chunk_id": 0,
        "type": "pdf",
        "created_at": "2024-01-01",
        "tags": ["python", "ai"]
    }
}
```

## 🔍 하이브리드 검색 전략

### 1단계: 멀티 쿼리 생성
- 원본 쿼리
- 유사어 확장
- 키워드 추출

### 2단계: 병렬 검색
- **벡터 검색**: Top-K 유사도 (코사인)
- **키워드 검색**: BM25 스코어링
- **메타데이터 필터**: 날짜, 소스, 태그

### 3단계: 리랭킹
- Cross-Encoder로 정밀 재순위
- MMR (Maximum Marginal Relevance)로 다양성 확보
- 관련성 점수 임계값 필터링

## 📊 청킹 전략

### Semantic Chunking
```python
chunk_config = {
    "max_tokens": 512,
    "overlap": 50,
    "split_by": "sentence",
    "preserve_context": True
}
```

### 문서 타입별 전략
- **PDF**: 페이지 + 섹션 단위
- **Code**: 함수/클래스 단위
- **Markdown**: 헤더 기반 분할
- **Chat**: 대화 턴 단위

## 🚀 성능 최적화

### 임베딩 캐싱
- SHA256 해시로 중복 방지
- Redis/SQLite 캐시 레이어
- 배치 처리 (32개 단위)

### 인덱싱 최적화
- FAISS HNSW 인덱스
- Async 병렬 처리
- 증분 인덱싱

### 검색 최적화
- 쿼리 캐싱 (LRU)
- 프리페칭
- 지연 로딩

## 📝 RAG 프롬프트 템플릿

```python
RAG_PROMPT = """
당신은 제공된 컨텍스트를 기반으로 정확한 답변을 하는 AI 어시스턴트입니다.

## 컨텍스트:
{context}

## 질문:
{question}

## 답변 규칙:
1. 컨텍스트에 있는 정보만 사용하세요
2. 모르는 경우 "제공된 정보에서 찾을 수 없습니다"라고 답하세요
3. 출처를 명시하세요 (파일명, 페이지 등)
4. 단계별로 명확하게 설명하세요

답변:
"""
```

## 🛠️ 기술 스택

### Core RAG
- **ChromaDB**: 벡터 DB
- **Sentence-Transformers**: 임베딩
- **Langchain**: 문서 처리
- **FAISS**: 벡터 인덱싱

### Document Processing
- **PyPDF2**: PDF 파싱
- **python-docx**: Word 문서
- **BeautifulSoup**: 웹 스크래핑
- **tiktoken**: 토큰 카운팅

### Search Enhancement
- **rank-bm25**: 키워드 검색
- **cross-encoder**: 리랭킹
- **spaCy**: NER, 키워드 추출

## 📈 예상 성능

- **인덱싱 속도**: 1000 문서/분
- **검색 지연시간**: <100ms
- **정확도**: 90%+ (벤치마크 기준)
- **메모리 사용**: 1GB/100만 청크